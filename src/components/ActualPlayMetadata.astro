---
import CharacterSheet from "./CharacterSheet.astro";

interface Props {
    item: any;
    rpgDataMap?: Record<string, any>;
}

const { item, rpgDataMap = {} } = Astro.props;
---

<div class="actual-play-metadata">
    <div class="session-info">
        <div class="session-header">
            <span class="session-label">Sesi√≥n {item.data.session}</span>
            {item.data.arc && <span class="arc-badge">{item.data.arc}</span>}
        </div>
        <div class="session-details">
            <div class="detail-item">
                <span class="detail-label">Sistema:</span>
                <span class="detail-value">{item.data.system}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Guionista:</span>
                <span class="detail-value">{item.data.gm}</span>
            </div>
            {
                item.data.datePlayed && (
                    <div class="detail-item">
                        <span class="detail-label">Fecha:</span>
                        <time class="detail-value">
                            {new Date(item.data.datePlayed).toLocaleDateString(
                                "es-ES",
                                {
                                    year: "numeric",
                                    month: "long",
                                    day: "numeric",
                                },
                            )}
                        </time>
                    </div>
                )
            }
        </div>
    </div>

    {
        item.data.players && item.data.players.length > 0 && (
            <div class="participants-section">
                <h3 class="participants-title">Jugadores</h3>
                <div class="participants-grid">
                    {item.data.players.map((player: any) => {
                        const hasRpg = player.rpgId && rpgDataMap[player.rpgId];
                        return (
                            <>
                                <div
                                    class={`participant-card ${hasRpg ? "clickable" : ""}`}
                                    style={`border-left: 4px solid ${player.color || "#666"}`}
                                    onclick={
                                        hasRpg
                                            ? `document.getElementById('dialog-${player.rpgId}').showModal()`
                                            : undefined
                                    }
                                >
                                    {player.icon && (
                                        <img
                                            src={player.icon}
                                            alt={player.character}
                                            class="participant-icon"
                                        />
                                    )}
                                    <div class="participant-info">
                                        <div
                                            class="participant-character"
                                            style={`color: ${player.color || "#666"}`}
                                        >
                                            {player.character}
                                        </div>
                                        <div class="participant-player">
                                            {player.name}
                                        </div>
                                    </div>
                                    {hasRpg && (
                                        <span
                                            class="view-sheet-icon"
                                            title="Ver ficha"
                                        >
                                            üëÅÔ∏è
                                        </span>
                                    )}
                                </div>
                                {hasRpg && (
                                    <dialog
                                        id={`dialog-${player.rpgId}`}
                                        class="character-dialog"
                                    >
                                        <div class="dialog-content">
                                            <div class="dialog-header">
                                                <div class="header-info">
                                                    <img
                                                        src={player.icon}
                                                        class="dialog-icon"
                                                    />
                                                    <span class="dialog-title">
                                                        {player.character}
                                                    </span>
                                                </div>
                                                <button
                                                    class="close-btn"
                                                    onclick={`document.getElementById('dialog-${player.rpgId}').close()`}
                                                >
                                                    ‚úï
                                                </button>
                                            </div>
                                            <div class="dialog-body">
                                                <CharacterSheet
                                                    rpg={
                                                        rpgDataMap[player.rpgId]
                                                    }
                                                />
                                            </div>
                                        </div>
                                    </dialog>
                                )}
                            </>
                        );
                    })}
                </div>
            </div>
        )
    }

    {
        item.data.npcs && item.data.npcs.length > 0 && (
            <div class="participants-section">
                <h3 class="participants-title">NPCs</h3>
                <div class="participants-grid">
                    {item.data.npcs.map((npc: any) => {
                        const hasRpg = npc.rpgId && rpgDataMap[npc.rpgId];
                        return (
                            <>
                                <div
                                    class={`participant-card ${hasRpg ? "clickable" : ""}`}
                                    style={`border-left: 4px solid ${npc.color || "#888"}`}
                                    onclick={
                                        hasRpg
                                            ? `document.getElementById('dialog-${npc.rpgId}').showModal()`
                                            : undefined
                                    }
                                >
                                    {npc.icon && (
                                        <img
                                            src={npc.icon}
                                            alt={npc.name}
                                            class="participant-icon"
                                        />
                                    )}
                                    <div class="participant-info">
                                        <div
                                            class="participant-character"
                                            style={`color: ${npc.color || "#888"}`}
                                        >
                                            {npc.name}
                                        </div>
                                        <div class="participant-info-row">
                                            {hasRpg && (
                                                <span class="rpg-badge">
                                                    RPG
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                    {hasRpg && (
                                        <span
                                            class="view-sheet-icon"
                                            title="Ver ficha"
                                        >
                                            üëÅÔ∏è
                                        </span>
                                    )}
                                </div>
                                {hasRpg && (
                                    <dialog
                                        id={`dialog-${npc.rpgId}`}
                                        class="character-dialog"
                                    >
                                        <div class="dialog-content">
                                            <div class="dialog-header">
                                                <div class="header-info">
                                                    <img
                                                        src={npc.icon}
                                                        class="dialog-icon"
                                                    />
                                                    <span class="dialog-title">
                                                        {npc.name}
                                                    </span>
                                                </div>
                                                <button
                                                    class="close-btn"
                                                    onclick={`document.getElementById('dialog-${npc.rpgId}').close()`}
                                                >
                                                    ‚úï
                                                </button>
                                            </div>
                                            <div class="dialog-body">
                                                <CharacterSheet
                                                    rpg={rpgDataMap[npc.rpgId]}
                                                />
                                            </div>
                                        </div>
                                    </dialog>
                                )}
                            </>
                        );
                    })}
                </div>
            </div>
        )
    }

    {
        item.data.tags && item.data.tags.length > 0 && (
            <div class="tags-section">
                {item.data.tags.map((tag: string) => (
                    <span class="tag">{tag}</span>
                ))}
            </div>
        )
    }
</div>

<style>
    .actual-play-metadata {
        background: var(--color-background-alt);
        border-radius: 8px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }

    .session-info {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .session-header {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .session-label {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--color-primary);
        font-family: var(--font-comic);
    }

    .arc-badge {
        background: var(--color-secondary);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        align-self: flex-start;
    }

    .session-details {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .detail-label {
        font-weight: 700;
        color: var(--color-accent);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .detail-value {
        color: var(--color-text);
        font-size: 0.875rem;
    }

    .participants-section {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .participants-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--color-secondary);
        font-family: var(--font-comic);
        margin: 0;
    }

    .participants-grid {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .participant-card {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: white;
        padding: 0.5rem;
        border-radius: 4px;
        transition: transform 0.2s ease;
    }

    .participant-card:hover {
        transform: translateX(2px);
    }

    .participant-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
    }

    .participant-info {
        flex: 1;
        min-width: 0;
    }

    .participant-character {
        font-weight: 700;
        font-size: 0.875rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.2;
    }

    .participant-player {
        font-size: 0.75rem;
        color: #666;
        line-height: 1.2;
    }

    .tags-section {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
        padding-top: 0.75rem;
        border-top: 1px solid var(--color-border);
    }

    .tag {
        background: var(--color-primary);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: lowercase;
    }

    @media (max-width: 1024px) {
        .actual-play-metadata {
            padding: 1.5rem;
        }

        .session-header {
            flex-direction: row;
            align-items: center;
            gap: 1rem;
        }

        .session-label {
            font-size: 1.5rem;
        }

        .participants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .participant-card:hover {
            transform: translateY(-2px);
        }
    }

    /* Interactive Features */
    .participant-card.clickable {
        cursor: pointer;
        position: relative;
    }

    .participant-card.clickable:hover {
        background: #f0f7ff;
        border-color: var(--color-primary) !important;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .view-sheet-icon {
        opacity: 0;
        transition: opacity 0.2s;
        font-size: 1.2rem;
    }

    .participant-card:hover .view-sheet-icon {
        opacity: 1;
    }

    .participant-info-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .rpg-badge {
        font-size: 0.65rem;
        background: var(--color-secondary);
        color: white;
        padding: 1px 4px;
        border-radius: 3px;
        font-weight: bold;
    }

    /* Dialog/Modal Styles */
    .character-dialog {
        padding: 0;
        border: none;
        border-radius: 12px;
        background: transparent;
        max-width: 90vw;
        max-height: 90vh;
        width: 800px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    }

    .character-dialog::backdrop {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(3px);
    }

    .dialog-content {
        background: #f9f7f1; /* Match character sheet bg */
        display: flex;
        flex-direction: column;
        height: 100%;
        max-height: 90vh;
        border-radius: 12px;
        overflow: hidden;
    }

    .dialog-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background: white;
        border-bottom: 2px solid var(--color-secondary);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .header-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .dialog-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--color-primary);
    }

    .dialog-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--color-primary-dark);
        font-family: var(--font-comic);
        text-transform: uppercase;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .close-btn:hover {
        background: #eee;
        color: var(--color-primary);
        transform: rotate(90deg);
    }

    .dialog-body {
        overflow-y: auto;
        padding: 1rem;
        flex: 1;
    }

    /* Hide the CharacterSheet default margin/shadow when inside modal */
    .dialog-body :global(.character-sheet) {
        margin: 0;
        box-shadow: none;
        border: none;
    }
</style>
